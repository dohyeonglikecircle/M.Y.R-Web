{% extends "base.html" %}

{% block content %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<style>
    .bg-purple { background-color: #6f42c1 !important; color: white !important; }
    .border-purple { border-color: #6f42c1 !important; }
    .text-purple { color: #6f42c1 !important; }
</style>

<div class="row">
    <div class="col-md-9">
        
        <div class="p-4 mb-4 bg-light rounded-3 border">
            <h1 class="display-6 fw-bold">
                {% if session_type == 'vocal' %}ğŸ¤{% elif session_type == 'guitar' %}ğŸ¸{% elif session_type == 'bass' %}ğŸ¸{% elif session_type == 'drum' %}ğŸ¥{% elif session_type == 'keyboard' %}ğŸ¹{% endif %}
                {{ type }} ì„¸ì…˜
            </h1>
            <p class="lead text-muted mb-0">
                {% if session_type in ['keyboard', 'drum'] %}
                    ë™ë°© ì•…ê¸° ì‚¬ìš© ì˜ˆì•½ (ê³µì—° ê¸°ê°„ í•œì •)
                {% else %}
                    {{ type }} ë©¤ë²„ ê³µê°„
                {% endif %}
            </p>
        </div>

        {% macro inst_card(code, color_class) %}
            {% set inst = inst_status[code] %}
            <div class="col"><div class="card h-100 border-{{ color_class }}"><div class="card-header bg-{{ color_class }} text-white d-flex justify-content-between align-items-center"><small class="fw-bold">{{ inst.name }}</small>{% if inst.is_available %} <span class="badge bg-light text-dark">ëŒ€ì—¬ ê°€ëŠ¥</span> {% else %} <span class="badge bg-dark">ëŒ€ì—¬ ë¶ˆê°€</span> {% endif %}</div><div class="position-relative bg-white text-center"><img src="{{ url_for('static', filename='images/' + code + '.jpg') }}" class="card-img-top p-2" style="height: 250px; object-fit: contain;" alt="{{ inst.name }}">{% if not inst.is_available %} <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center"><h3 class="text-white fw-bold">â›” ìˆ˜ë¦¬ ì¤‘ / ë¶ˆê°€</h3></div> {% endif %}</div>{% if current_user.is_admin %}<div class="card-footer bg-transparent border-{{ color_class }}"><form method="POST" class="d-grid"><input type="hidden" name="action_type" value="toggle_status"><input type="hidden" name="target_code" value="{{ code }}">{% if inst.is_available %} <button class="btn btn-outline-dark btn-sm">ğŸ”’ ëŒ€ì—¬ ë§‰ê¸°</button> {% else %} <button class="btn btn-outline-success btn-sm">ğŸ”“ ëŒ€ì—¬ í’€ê¸°</button> {% endif %}</form></div>{% endif %}</div></div>
        {% endmacro %}

        {% if session_type == 'guitar' %}
            <div class="accordion mb-4 shadow-sm" id="guitarAccordion"><div class="accordion-item"><h2 class="accordion-header" id="headingOne"><button class="accordion-button collapsed fw-bold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePhotos">ğŸ¸ ë³´ìœ  ì¥ë¹„ ë° ëŒ€ì—¬ í˜„í™© í™•ì¸</button></h2><div id="collapsePhotos" class="accordion-collapse collapse" data-bs-parent="#guitarAccordion"><div class="accordion-body bg-white"><div class="row row-cols-1 row-cols-md-2 g-3">{{ inst_card('guitar1', 'danger') }} {{ inst_card('guitar2', 'warning') }} {{ inst_card('guitar3', 'success') }} {{ inst_card('geffect', 'primary') }}</div></div></div></div></div>
            <div class="row"><div class="col-md-8 mb-3"><div class="card shadow-sm h-100"><div class="card-body"><h5 class="card-title fw-bold mb-3">ğŸ“… ëŒ€ì—¬ í˜„í™© (4ì¼ê°„)</h5><div id='calendar'></div></div></div></div><div class="col-md-4 mb-3"><div class="card shadow-sm border-primary h-100"><div class="card-header bg-primary text-white fw-bold">ğŸ“ ì˜ˆì•½í•˜ê¸°</div><div class="card-body"><form method="POST"><input type="hidden" name="action_type" value="reserve"><div class="mb-3"><label class="form-label small fw-bold">ì¥ë¹„</label><select class="form-select" name="item_type" required><option value="" disabled selected>ì„ íƒ</option>{% for code in ['guitar1', 'guitar2', 'guitar3', 'geffect'] %}{% set inst = inst_status[code] %}<option value="{{ code }}" {% if not inst.is_available %}disabled{% endif %}>{{ inst.name }} {% if not inst.is_available %}(â›”){% endif %}</option>{% endfor %}</select></div><div class="mb-3"><label class="form-label small fw-bold">ì‹œì‘</label><input type="datetime-local" class="form-control" name="start_date" required></div><div class="mb-3"><label class="form-label small fw-bold">ë°˜ë‚©</label><input type="datetime-local" class="form-control" name="end_date" required></div><div class="d-grid"><button type="submit" class="btn btn-primary">ì˜ˆì•½</button></div></form></div></div></div></div>

        {% elif session_type == 'bass' %}
            <div class="accordion mb-4 shadow-sm" id="bassAccordion"><div class="accordion-item"><h2 class="accordion-header" id="headingBass"><button class="accordion-button collapsed fw-bold text-purple" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBassPhotos">ğŸ¸ ë² ì´ìŠ¤ ì¥ë¹„ í™•ì¸</button></h2><div id="collapseBassPhotos" class="accordion-collapse collapse" data-bs-parent="#bassAccordion"><div class="accordion-body bg-white"><div class="row row-cols-1 row-cols-md-2 g-3">{{ inst_card('bass1', 'success') }} {{ inst_card('bass2', 'primary') }} {{ inst_card('bass3', 'purple') }} {{ inst_card('beffect', 'warning') }}</div></div></div></div></div>
            <div class="row"><div class="col-md-8 mb-3"><div class="card shadow-sm h-100"><div class="card-body"><h5 class="card-title fw-bold mb-3">ğŸ“… ëŒ€ì—¬ í˜„í™© (4ì¼ê°„)</h5><div id='calendar'></div></div></div></div><div class="col-md-4 mb-3"><div class="card shadow-sm border-purple h-100"><div class="card-header bg-purple text-white fw-bold">ğŸ“ ì˜ˆì•½í•˜ê¸°</div><div class="card-body"><form method="POST"><input type="hidden" name="action_type" value="reserve"><div class="mb-3"><label class="form-label small fw-bold">ì¥ë¹„</label><select class="form-select" name="item_type" required><option value="" disabled selected>ì„ íƒ</option>{% for code in ['bass1', 'bass2', 'bass3', 'beffect'] %}{% set inst = inst_status[code] %}<option value="{{ code }}" {% if not inst.is_available %}disabled{% endif %}>{{ inst.name }} {% if not inst.is_available %}(â›”){% endif %}</option>{% endfor %}</select></div><div class="mb-3"><label class="form-label small fw-bold">ì‹œì‘</label><input type="datetime-local" class="form-control" name="start_date" required></div><div class="mb-3"><label class="form-label small fw-bold">ë°˜ë‚©</label><input type="datetime-local" class="form-control" name="end_date" required></div><div class="d-grid"><button type="submit" class="btn bg-purple text-white">ì˜ˆì•½</button></div></form></div></div></div></div>

        {% elif session_type in ['keyboard', 'drum'] %}
            {% set theme = 'warning' if session_type == 'keyboard' else 'danger' %}
            {% set theme_text = 'text-dark' if session_type == 'keyboard' else 'text-white' %}
            {% set inst = inst_status[session_type] %}

            {% if not inst.is_available %}
                <div class="card text-center py-5 border-{{ theme }} shadow-sm">
                    <div class="card-body">
                        <h1 class="display-1">â›”</h1>
                        <h2 class="fw-bold mt-3">í˜„ì¬ ì˜ˆì•½ ì‹œìŠ¤í…œì´ ë‹«í˜€ìˆìŠµë‹ˆë‹¤.</h2>
                        <p class="text-muted">ê³µì—° ê¸°ê°„ì—ë§Œ í™œì„±í™”ë˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.<br>ë¬¸ì˜ì‚¬í•­ì€ íŒŒíŠ¸ì¥ì—ê²Œ ì—°ë½ì£¼ì„¸ìš”.</p>
                        
                        {% if current_user.is_admin %}
                        <div class="mt-4">
                            <form method="POST">
                                <input type="hidden" name="action_type" value="toggle_status">
                                <input type="hidden" name="target_code" value="{{ session_type }}">
                                <button class="btn btn-outline-success btn-lg">ğŸ”“ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹œìŠ¤í…œ ì¼œê¸°</button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                </div>

            {% else %}
                
                {% if current_user.is_admin %}
                <div class="alert alert-success d-flex justify-content-between align-items-center">
                    <span>ğŸ’¡ í˜„ì¬ ì˜ˆì•½ ì‹œìŠ¤í…œì´ <b>ê°€ë™ ì¤‘</b>ì…ë‹ˆë‹¤.</span>
                    <form method="POST">
                        <input type="hidden" name="action_type" value="toggle_status">
                        <input type="hidden" name="target_code" value="{{ session_type }}">
                        <button class="btn btn-sm btn-outline-danger">ğŸ”’ ì‹œìŠ¤í…œ ë„ê¸° (ì¢…ë£Œ)</button>
                    </form>
                </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title fw-bold mb-3">ğŸ“… ë™ë°© ì‚¬ìš© í˜„í™©</h5>
                                <div id='calendar'></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card shadow-sm border-{{ theme }} h-100">
                            <div class="card-header bg-{{ theme }} {{ theme_text }} fw-bold">
                                ğŸ“ ë™ë°© ì‚¬ìš© ì˜ˆì•½
                            </div>
                            <div class="card-body">
                                <form method="POST">
                                    <input type="hidden" name="action_type" value="reserve">
                                    <input type="hidden" name="item_type" value="{{ session_type }}">
                                    
                                    <div class="mb-3">
                                        <p class="fw-bold mb-1">{{ inst.name }}</p>
                                        <span class="badge bg-success">ì‚¬ìš© ê°€ëŠ¥</span>
                                    </div>

                                    <div class="mb-3"><label class="form-label small fw-bold">ì‹œì‘ ì‹œê°„</label><input type="datetime-local" class="form-control" name="start_date" required></div>
                                    <div class="mb-3"><label class="form-label small fw-bold">ì¢…ë£Œ ì‹œê°„</label><input type="datetime-local" class="form-control" name="end_date" required></div>
                                    <div class="d-grid"><button type="submit" class="btn btn-{{ theme }}">ì˜ˆì•½ ì‹ ì²­</button></div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

        {% elif session_type == 'vocal' %}
            <div class="card shadow-sm text-center py-5 border-0 bg-white"><div class="card-body"><h1 class="text-muted mb-3" style="font-size: 4rem;">ğŸš§</h1><h3 class="text-dark fw-bold">ì•„ì§ ë“±ë¡ëœ ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤</h3></div></div>
        {% endif %}
    </div>

    <div class="col-md-3">
        {% if leader %}
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-dark text-white fw-bold">â­ íŒŒíŠ¸ì¥ ì†Œê°œ</div>
            <div class="card-body">
                <h5 class="card-title fw-bold">{{ leader.name }}</h5>
                <p class="card-text text-muted small mb-3">{{ leader.intro }}</p>
                {% if leader.insta %}<div class="d-grid"><a href="{{ leader.insta }}" target="_blank" class="btn btn-outline-danger btn-sm">Instagram DM</a></div>{% endif %}
            </div>
        </div>
        {% endif %}
        <div class="list-group shadow-sm"><a href="#" class="list-group-item list-group-item-action active">{{ type }} ê³µì§€ì‚¬í•­</a></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            var myEvents = {{ events_data | tojson }};
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridFourDay', locale: 'ko', height: 'auto',
                views: { timeGridFourDay: { type: 'timeGrid', duration: { days: 4 }, buttonText: '4ì¼ ë³´ê¸°' } },
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridFourDay,dayGridMonth' },
                events: myEvents, eventDisplay: 'block', nowIndicator: true, slotMinTime: '09:00:00', slotMaxTime: '24:00:00', allDaySlot: false, expandRows: true
            });
            calendar.render();
        }
    });
</script>
{% endblock %}