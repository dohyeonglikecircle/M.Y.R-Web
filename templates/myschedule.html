{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-11">
        <div class="card shadow-sm border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">üïí ÎÇ¥ Í∞ÄÎä• ÏãúÍ∞Ñ (ÎÇ†ÏßúÎ≥Ñ ÏûÖÎ†•)</h4>
                <button class="btn btn-light text-primary fw-bold" onclick="saveSchedule()">Ï†ÄÏû•ÌïòÍ∏∞</button>
            </div>
            
            <div class="card-body p-0">
                <div id="weekCarousel" class="carousel slide" data-bs-interval="false">
                    <div class="carousel-inner">
                        
                        {% for week in weeks %}
                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                            <div class="p-3 bg-light border-bottom text-center">
                                <h5 class="fw-bold mb-0">({{ week[0].display }} ~ {{ week[-1].display }})</h5>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered text-center table-sm mb-0 unselectable" style="font-size: 0.8rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 60px;">Time</th>
                                            {% for day in week %}
                                                <th class="{{ 'text-muted bg-secondary bg-opacity-10' if day.is_past else '' }}">
                                                    {{ day.display }}
                                                </th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for i in range(30) %}
                                        <tr>
                                            <td class="bg-light fw-bold align-middle">
                                                {{ 9 + (i // 2) }}:{{ '00' if i % 2 == 0 else '30' }}
                                            </td>
                                            
                                            {% for day in week %}
                                                {% if day.is_past %}
                                                    <td class="bg-secondary bg-opacity-10"></td>
                                                {% else %}
                                                    <td class="time-cell" 
                                                        data-date="{{ day.date }}" 
                                                        data-index="{{ i }}"
                                                        style="cursor: pointer;">
                                                    </td>
                                                {% endif %}
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                        
                    </div>
                    
                    <button class="carousel-control-prev" type="button" data-bs-target="#weekCarousel" data-bs-slide="prev" style="width: 5%;">
                        <span class="carousel-control-prev-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#weekCarousel" data-bs-slide="next" style="width: 5%;">
                        <span class="carousel-control-next-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="saveForm" method="POST" style="display:none;">
    <input type="hidden" name="schedule_data" id="scheduleDataInput">
</form>

<style>
    .unselectable { user-select: none; }
    /* ÏÑ†ÌÉùÎêú ÏÖÄ Ïä§ÌÉÄÏùº (Ï¥àÎ°ùÏÉâ) */
    .bg-success { background-color: #198754 !important; }
</style>

<script>
    // ÎÇ¥ Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞ (YYYY-MM-DD ÌÇ§)
    let myData = {{ my_schedule | tojson }};
    
    // Ï¥àÍ∏∞ Î†åÎçîÎßÅ (Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú)
    document.querySelectorAll('.time-cell').forEach(cell => {
        let date = cell.dataset.date;
        let idx = cell.dataset.index;
        
        if (myData[date] && myData[date][idx] === 1) {
            cell.classList.add('bg-success');
        }
    });

    // ÎìúÎûòÍ∑∏ Î°úÏßÅ
    let isMouseDown = false;
    let toggleMode = 1; // 1: Ïπ†ÌïòÍ∏∞, 0: ÏßÄÏö∞Í∏∞

    document.querySelectorAll('.time-cell').forEach(cell => {
        cell.addEventListener('mousedown', function() {
            isMouseDown = true;
            let date = this.dataset.date;
            let idx = this.dataset.index;
            
            // Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
            if (!myData[date]) myData[date] = Array(30).fill(0);
            
            // ÌòÑÏû¨ ÏÉÅÌÉúÏùò Î∞òÎåÄÎ°ú ÌÜ†Í∏Ä
            toggleMode = myData[date][idx] === 1 ? 0 : 1;
            updateCell(this);
        });
        
        cell.addEventListener('mouseover', function() {
            if (isMouseDown) updateCell(this);
        });
    });
    
    document.addEventListener('mouseup', () => isMouseDown = false);

    function updateCell(cell) {
        let date = cell.dataset.date;
        let idx = cell.dataset.index;
        
        if (!myData[date]) myData[date] = Array(30).fill(0);
        
        if (toggleMode === 1) {
            myData[date][idx] = 1;
            cell.classList.add('bg-success');
        } else {
            myData[date][idx] = 0;
            cell.classList.remove('bg-success');
        }
    }

    function saveSchedule() {
        document.getElementById('scheduleDataInput').value = JSON.stringify(myData);
        document.getElementById('saveForm').submit();
    }
</script>
{% endblock %}