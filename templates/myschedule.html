{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">ğŸ•’ ë‚´ ê°€ëŠ¥ ì‹œê°„ ì…ë ¥ (Every Week)</h4>
                <button class="btn btn-light text-primary fw-bold" onclick="saveSchedule()">ì €ì¥í•˜ê¸°</button>
            </div>
            <div class="card-body">
                <p class="text-muted small">
                    * ë“œë˜ê·¸í•˜ì—¬ ê°€ëŠ¥í•œ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”. (ë…¹ìƒ‰ = ê°€ëŠ¥)<br>
                    * ë§¤ì£¼ ë°˜ë³µë˜ëŠ” ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (09:00 ~ 24:00, 30ë¶„ ë‹¨ìœ„)<br>
                    * íŒ€ í•©ì£¼ê°€ í™•ì •ë˜ë©´ ê·¸ ì‹œê°„ì€ ìë™ìœ¼ë¡œ ë¶ˆê°€ëŠ¥ ì²˜ë¦¬ë©ë‹ˆë‹¤.
                </p>

                <div class="table-responsive">
                    <table class="table table-bordered text-center table-sm" id="scheduleTable" style="font-size: 0.8rem;">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px;">Time</th>
                                <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
                            </tr>
                        </thead>
                        <tbody id="gridBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="saveForm" method="POST" style="display:none;">
    <input type="hidden" name="schedule_data" id="scheduleDataInput">
</form>

<script>
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    // 09:00 ~ 24:00 (15ì‹œê°„ * 2 = 30ì¹¸)
    const startHour = 9;
    const totalSlots = 30; 
    
    // DBì—ì„œ ë¶ˆëŸ¬ì˜¨ ë‚´ ìŠ¤ì¼€ì¤„ (ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´)
    let myData = {{ my_schedule | tojson }};
    
    // ì´ˆê¸°í™”: ë°ì´í„° ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì±„ì›€
    days.forEach(d => {
        if (!myData[d]) myData[d] = Array(totalSlots).fill(0);
    });

    const tbody = document.getElementById('gridBody');
    let isMouseDown = false;
    let toggleMode = 1; // 1: ì¹ í•˜ê¸°, 0: ì§€ìš°ê¸°

    // ê·¸ë¦¬ë“œ ìƒì„±
    for (let i = 0; i < totalSlots; i++) {
        let tr = document.createElement('tr');
        
        // ì‹œê°„ ë¼ë²¨ (1ì‹œê°„ ë‹¨ìœ„ë¡œë§Œ í‘œì‹œ)
        let th = document.createElement('td');
        let hour = startHour + Math.floor(i / 2);
        let min = (i % 2 === 0) ? '00' : '30';
        th.innerText = `${hour}:${min}`;
        th.className = 'bg-light fw-bold align-middle';
        tr.appendChild(th);

        // ìš”ì¼ë³„ ì…€ ìƒì„±
        days.forEach(day => {
            let td = document.createElement('td');
            td.dataset.day = day;
            td.dataset.index = i;
            td.style.cursor = 'pointer';
            td.style.height = '30px';
            
            // ì €ì¥ëœ ë°ì´í„° ë°˜ì˜
            if (myData[day][i] === 1) {
                td.classList.add('bg-success');
            }

            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ (ë“œë˜ê·¸)
            td.addEventListener('mousedown', function() {
                isMouseDown = true;
                // í˜„ì¬ ìƒíƒœì˜ ë°˜ëŒ€ë¡œ í† ê¸€ ëª¨ë“œ ì„¤ì •
                toggleMode = myData[day][i] === 1 ? 0 : 1;
                updateCell(this);
            });
            td.addEventListener('mouseover', function() {
                if (isMouseDown) updateCell(this);
            });
            td.addEventListener('mouseup', () => isMouseDown = false);
            
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    }

    // ë¬¸ì„œ ì „ì²´ì—ì„œ ë§ˆìš°ìŠ¤ ë–¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ
    document.addEventListener('mouseup', () => isMouseDown = false);

    function updateCell(cell) {
        let day = cell.dataset.day;
        let idx = cell.dataset.index;
        
        if (toggleMode === 1) {
            myData[day][idx] = 1;
            cell.classList.add('bg-success');
        } else {
            myData[day][idx] = 0;
            cell.classList.remove('bg-success');
        }
    }

    function saveSchedule() {
        document.getElementById('scheduleDataInput').value = JSON.stringify(myData);
        document.getElementById('saveForm').submit();
    }
</script>
{% endblock %}